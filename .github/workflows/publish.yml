# ============================================================================
# Publish to npm (Beginner Safe Version)
# ============================================================================
#
# 使用方式：
# 1. 本地先修改 package.json 里的 version
# 2. git commit
# 3. git tag vX.Y.Z
# 4. git push && git push --tags
# 5. GitHub Actions 自动发布到 npm
# ============================================================================

name: Publish to npm

# ----------------------------------------------------------------------------
# 触发条件
# ----------------------------------------------------------------------------
# 只有当 push 形如 v1.2.3 的 tag 时才会触发
# 这是最安全、最不容易出错的发布方式
# ----------------------------------------------------------------------------
on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest

    # ------------------------------------------------------------------------
    # 权限
    # ------------------------------------------------------------------------
    # contents: read 即可，不需要写权限
    # 不使用 provenance，不需要 id-token
    # ------------------------------------------------------------------------
    permissions:
      contents: read

    # ------------------------------------------------------------------------
    # 环境变量
    # ------------------------------------------------------------------------
    # NPM_TOKEN 来自 GitHub Secrets
    # npm publish / npm whoami 都会自动使用它
    # ------------------------------------------------------------------------
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      # ----------------------------------------------------------------------
      # Step 1: Checkout
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # ----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm

      # ----------------------------------------------------------------------
      # Step 3: Print environment info（调试必备）
      # ----------------------------------------------------------------------
      - name: Print environment info
        run: |
          set -x
          node -v
          npm -v
          npm config get registry

      # ----------------------------------------------------------------------
      # Step 4: Install dependencies
      # ----------------------------------------------------------------------
      - name: Install dependencies
        run: |
          set -euxo pipefail
          npm ci

      # ----------------------------------------------------------------------
      # Step 5: Run tests（如果你没有 test，可删除这一步）
      # ----------------------------------------------------------------------
      - name: Run tests
        run: |
          set -euxo pipefail
          npm test

      # ----------------------------------------------------------------------
      # Step 6: Build（如果你没有 build，可删除这一步）
      # ----------------------------------------------------------------------
      - name: Build
        run: |
          set -euxo pipefail
          npm run build || echo "No build step defined"

      # ----------------------------------------------------------------------
      # Step 7: Verify package content（发布前最重要的检查）
      # ----------------------------------------------------------------------
      - name: Verify package content
        run: |
          set -euxo pipefail
          echo "Package name:"
          node -p "require('./package.json').name"
          echo "Package version:"
          node -p "require('./package.json').version"
          echo "Files to be published:"
          npm pack --dry-run

      # ----------------------------------------------------------------------
      # Step 8: npm authentication check
      # ----------------------------------------------------------------------
      - name: Check npm authentication
        run: |
          set -euxo pipefail
          npm whoami

      # ----------------------------------------------------------------------
      # Step 9: Publish to npm（核心步骤）
      # ----------------------------------------------------------------------
      - name: Publish to npm
        run: |
          set -euxo pipefail
          npm publish --access public --loglevel verbose

      # ----------------------------------------------------------------------
      # Step 10: Dump npm debug logs if failed（防止 error 空白）
      # ----------------------------------------------------------------------
      - name: Dump npm debug logs
        if: failure()
        run: |
          echo "===== npm debug logs ====="
          ls -la ~/.npm/_logs || true
          cat ~/.npm/_logs/*-debug-0.log || true
