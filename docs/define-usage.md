# #define 预处理器常量使用指南

## 概述

`#define` 预处理器常量可以让 ISS 脚本更易维护。本文档说明如何正确使用。

## ✅ 正确用法

### 1. 在 Defines 中定义常量

```typescript
Defines: {
  MyAppName: "Police Self Report",
  MyAppVersion: "1.0.0",
  MyAppPublisher: "合肥视尔信息科技有限公司",
  MyAppExeName: "Police Self Report.exe",
  MyAppAssocName: "Police Self Report File",      // 已经是计算后的值
  MyAppAssocExt: ".myp",
  MyAppAssocKey: "PoliceSelfReportFile.myp",       // 已经是计算后的值
  MyAppShortcutName: "公安自助接报案系统",
}
```

**注意**：`Defines` 中的值应该是**最终计算后的字符串**，不要包含 `StringChange(...)` 等表达式。

### 2. 在配置中使用 {#...} 引用

```typescript
Setup: {
  AppName: "{#MyAppName}",                    // ✅ 使用 {#...} 引用
  AppVersion: "{#MyAppVersion}",
  AppPublisher: "{#MyAppPublisher}",
  DefaultDirName: "{autopf}\\{#MyAppName}",
},
Icons: [
  {
    Name: "{group}\\{#MyAppShortcutName}",    // ✅ 引用常量
    Filename: "{app}\\{#MyAppExeName}",
  },
],
Registry: [
  {
    Root: "HKCR",
    Subkey: "{#MyAppAssocExt}",               // ✅ 引用常量
    ValueType: "string",
    ValueName: "",
    ValueData: "{#MyAppAssocKey}",
  },
]
```

## ❌ 错误用法

### 错误 1：在 Defines 中使用未计算的表达式

```typescript
// ❌ 错误：Defines 中不应该包含表达式
Defines: {
  MyAppAssocKey: "StringChange(MyAppAssocName, \" \", \"\").myp",  // ❌
}
```

**正确做法**：手动计算或在定义时就使用最终值

```typescript
// ✅ 正确
Defines: {
  MyAppAssocKey: "PoliceSelfReportFile.myp",  // 直接使用计算后的值
}
```

### 错误 2：在配置中不使用 {#...} 引用

```typescript
// ❌ 错误：没有使用 {#...} 引用
Setup: {
  AppName: "Police Self Report",        // ❌ 直接使用字符串
}

Registry: [
  {
    Subkey: "PoliceSelfReportFile.myp", // ❌ 直接使用字符串
  }
]
```

**正确做法**：使用 `{#...}` 引用

```typescript
// ✅ 正确
Setup: {
  AppName: "{#MyAppName}",              // ✅ 使用引用
}

Registry: [
  {
    Subkey: "{#MyAppAssocKey}",         // ✅ 使用引用
  }
]
```

## 生成的 ISS 脚本

使用正确的配置后，生成的脚本将是：

```iss
; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

#define MyAppName "Police Self Report"
#define MyAppVersion "1.0.0"
#define MyAppPublisher "合肥视尔信息科技有限公司"
#define MyAppExeName "Police Self Report.exe"
#define MyAppAssocName "Police Self Report File"
#define MyAppAssocExt ".myp"
#define MyAppAssocKey "PoliceSelfReportFile.myp"
#define MyAppShortcutName "公安自助接报案系统"

[Setup]
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}

[Icons]
Name: "{group}\{#MyAppShortcutName}"; Filename: "{app}\{#MyAppExeName}"

[Registry]
Root: HKCR; Subkey: "{#MyAppAssocExt}"; ValueType: string; ValueName: ""; ValueData: "{#MyAppAssocKey}"
```

## 如何转换现有配置

如果你有以下配置：

```typescript
{
  Defines: {
    MyAppAssocKey: "StringChange(MyAppAssocName, \" \", \"\").myp",  // 问题在这里
  },
  Registry: [
    {
      Subkey: "StringChange(MyAppAssocName, \" \", \"\").myp",       // 问题在这里
    }
  ]
}
```

应该改为：

```typescript
{
  Defines: {
    MyAppAssocKey: "PoliceSelfReportFile.myp",  // 直接使用计算后的值
  },
  Registry: [
    {
      Subkey: "{#MyAppAssocKey}",                 // 使用 {#...} 引用
    }
  ]
}
```

## ISS 脚本到 TypeScript 配置转换

如果你有原始的 ISS 脚本：

```iss
#define MyAppAssocName MyAppName + " File"
#define MyAppAssocKey StringChange(MyAppAssocName, " ", "") + MyAppAssocExt

[Registry]
Root: HKCR; Subkey: "{#MyAppAssocKey}"
```

转换为 TypeScript 时：

1. **计算 Defines 的最终值**
2. **在配置中使用 `{#...}` 引用**

```typescript
{
  Defines: {
    MyAppAssocName: "Police Self Report File",    // 已计算
    MyAppAssocKey: "PoliceSelfReportFile.myp",    // 已计算
  },
  Registry: [
    {
      Subkey: "{#MyAppAssocKey}",                 // 使用引用
    }
  ]
}
```

## 总结

✅ **DO**：

- 在 `Defines` 中使用最终计算后的值
- 在配置中使用 `{#ConstantName}` 引用常量
- 保持生成的 ISS 脚本简洁清晰

❌ **DON'T**：

- 不要在 `Defines` 中包含未计算的表达式
- 不要在配置中直接使用字符串值而不引用常量
- 不要混合使用引用和直接值
