# ============================================================================
# CI (Continuous Integration) - 持续集成工作流
# ============================================================================
# 作用: 每次代码推送或 PR 时自动运行测试，确保代码质量
# 触发条件: 推送到 main/master/dev 分支，或针对这些分支的 Pull Request
# ============================================================================

name: CI

# ----------------------------------------------------------------------------
# 触发条件 (on)
# ----------------------------------------------------------------------------
# push: 当代码被推送到指定分支时触发
# pull_request: 当有 PR 指向指定分支时触发
# 这样可以确保所有进入主分支的代码都经过测试
# ----------------------------------------------------------------------------
on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]

jobs:
  # ==========================================================================
  # Job 1: 多版本测试
  # ==========================================================================
  # 目的: 在多个 Node.js 版本上运行测试，确保兼容性
  # matrix 策略: 并行运行多个版本的测试，提高效率
  # ==========================================================================
  test:
    name: Test on Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest # 使用 Ubuntu 最新版作为运行环境

    # 矩阵策略: 定义多个 Node.js 版本，GitHub Actions 会为每个版本创建一个独立的任务
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x] # 测试 Node.js 18, 20, 22 三个 LTS 版本

    steps:
      # ------------------------------------------------------------------------
      # Step 1: 检出代码
      # ------------------------------------------------------------------------
      # actions/checkout: 官方提供的检出仓库代码的 Action
      # 这一步会把你的代码从 GitHub 仓库下载到运行环境中
      # ------------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # Step 2: 设置 Node.js 环境
      # ------------------------------------------------------------------------
      # actions/setup-node: 官方提供的 Node.js 环境设置 Action
      # node-version: 使用 matrix 中定义的版本
      # cache: 'npm' 表示缓存 npm 依赖，加速后续构建
      # ------------------------------------------------------------------------
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      # ------------------------------------------------------------------------
      # Step 3: 安装依赖
      # ------------------------------------------------------------------------
      # npm ci: 类似 npm install，但更适合 CI 环境
      # - 严格按照 package-lock.json 安装
      # - 如果 lock 文件和 package.json 不一致会报错
      # - 速度更快，更可靠
      # ------------------------------------------------------------------------
      - name: Install dependencies
        run: |
          echo "========================================"
          echo "[Step] Installing dependencies..."
          echo "========================================"
          echo "Node version: $(node -v)"
          echo "npm version: $(npm -v)"
          echo ""
          npm ci
          echo ""
          echo "[Done] Dependencies installed successfully"

      # ------------------------------------------------------------------------
      # Step 4: 构建项目
      # ------------------------------------------------------------------------
      # 运行 TypeScript 编译，将 src/ 下的 .ts 文件编译到 dist/ 目录
      # ------------------------------------------------------------------------
      - name: Build
        run: |
          echo "========================================"
          echo "[Step] Building project..."
          echo "========================================"
          npm run build
          echo ""
          echo "[Info] Build output (dist/):"
          ls -la dist/
          echo ""
          echo "[Done] Build completed successfully"

      # ------------------------------------------------------------------------
      # Step 5: 运行测试
      # ------------------------------------------------------------------------
      # 执行 package.json 中定义的 test 脚本
      # 如果测试失败，整个 workflow 会标记为失败
      # ------------------------------------------------------------------------
      - name: Run tests
        run: |
          echo "========================================"
          echo "[Step] Running tests..."
          echo "========================================"
          npm test
          echo ""
          echo "[Done] All tests passed"

  # ==========================================================================
  # Job 2: 类型检查
  # ==========================================================================
  # 目的: 单独进行 TypeScript 类型检查，确保类型安全
  # --noEmit: 只检查类型，不生成输出文件
  # ==========================================================================
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x" # 类型检查使用稳定的 LTS 版本
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "========================================"
          echo "[Step] Installing dependencies..."
          echo "========================================"
          npm ci
          echo "[Done] Dependencies installed"

      # ------------------------------------------------------------------------
      # TypeScript 类型检查
      # ------------------------------------------------------------------------
      # tsc --noEmit: 运行 TypeScript 编译器但不生成文件
      # 这样可以检查所有类型错误而不影响构建
      # ------------------------------------------------------------------------
      - name: Type check
        run: |
          echo "========================================"
          echo "[Step] Running TypeScript type check..."
          echo "========================================"
          echo "TypeScript version: $(npx tsc --version)"
          echo ""
          npx tsc --noEmit
          echo ""
          echo "[Done] No type errors found"
